workflows:
  cordova-release-workflow:
    name: Cordova Android Release Build
    max_build_duration: 30
    environment:
      node: latest
      vars:
        CORDOVA_PLATFORM: android
        KEYSTORE_PATH: dccarlobos-key.jks
        KEYSTORE_PASSWORD: 143143
        KEY_ALIAS: ilovemoney
        KEY_PASSWORD: 143143

    scripts:
      - name: Install Cordova
        script: npm install -g cordova

      - name: Clean Workspace
        script: |
          echo "üßΩ Cleaning previous builds..."
          rm -rf platforms plugins node_modules || true
          npm install

      - name: Install Plugins (fresh)
        script: |
          echo "üì¶ Installing stable plugins..."
          cordova plugin add cordova-plugin-x-socialsharing-android12@6.0.5
          cordova plugin add cordova-plugin-inappbrowser
          cordova plugin add cordova-plugin-fullscreen
          cordova plugin add cordova-plugin-network-information
          cordova plugin add admob-plus-cordova@latest

      - name: Clean and Re-add Android Platform
        script: |
          echo "üßπ Re-adding Android platform cleanly..."
          cordova platform remove android || true
          cordova platform add android@14.0.1
          cordova prepare android

      - name: Verify Keystore
        script: |
          echo "üîê Checking keystore..."
          ls -l $KEYSTORE_PATH || (echo "‚ùå Keystore not found!" && exit 1)

      - name: Patch AndroidManifest (exported fix)
        script: |
          echo "ü©π Patching AndroidManifest.xml..."
          sed -i 's/<receiver android:name="nl.xservices.plugins.ShareChooserPendingIntent"/<receiver android:name="nl.xservices.plugins.ShareChooserPendingIntent" android:exported="true"/' platforms/android/app/src/main/AndroidManifest.xml || true

      - name: Remove duplicated AdMob meta-data if any
        script: |
          echo "üß© Removing possible duplicate APPLICATION_ID entries..."
          sed -i '/com.google.android.gms.ads.APPLICATION_ID/{n;d}' platforms/android/app/src/main/AndroidManifest.xml || true
          sed -i '/com.google.android.gms.ads.APPLICATION_ID/{d}' platforms/android/app/src/main/AndroidManifest.xml || true

      - name: Build Signed Release APK
        script: |
          echo "üèóÔ∏è Building signed release APK..."
          cordova build android --release \
            -- --packageType=apk \
               --keystore=$KEYSTORE_PATH \
               --storePassword=$KEYSTORE_PASSWORD \
               --alias=$KEY_ALIAS \
               --password=$KEY_PASSWORD

      - name: Build Signed Release AAB
        script: |
          echo "üèóÔ∏è Building signed release AAB..."
          cordova build android --release \
            -- --packageType=bundle \
               --keystore=$KEYSTORE_PATH \
               --storePassword=$KEYSTORE_PASSWORD \
               --alias=$KEY_ALIAS \
               --password=$KEY_PASSWORD

      - name: Verify Build Files
        script: |
          echo "‚úÖ Checking build outputs..."
          find platforms/android/app/build/outputs -type f \( -name "*.apk" -o -name "*.aab" \) || echo "‚ùå No build outputs found!"

    artifacts:
      - platforms/android/app/build/outputs/**/*.apk
      - platforms/android/app/build/outputs/**/*.aab